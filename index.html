<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motion Detection</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    h1 { font-size: 1.5rem; }
    #status { font-size: 1.3rem; margin-top: 20px; padding: 10px; border: 2px solid #333; display: inline-block; }
    button { margin: 5px; padding: 10px 15px; font-size: 1rem; }
    .moving { color: green; }
    .stopped { color: red; }
    .controls { margin-top: 20px; }
    .controls label { display: block; margin: 10px 0 5px; }
    #sensorData { margin-top: 20px; text-align: left; display: inline-block; max-height: 300px; overflow-y: auto; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #333; padding: 5px; text-align: center; }
  </style>
</head>
<body>
  <h1>Phone Motion Detection</h1>
  <p>Press the button to allow motion/orientation permissions and start detection.</p>
  <button id="startBtn">Start Detection</button>
  <div id="status">Waiting for input...</div>

  <div class="controls">
    <label for="threshold">Motion Sensitivity (Threshold: <span id="thresholdValue">1.0</span>)</label>
    <input type="range" id="threshold" min="0.1" max="5.0" step="0.1" value="1.0">

    <label for="bufferSize">Buffer Size (Readings: <span id="bufferValue">5</span>)</label>
    <input type="range" id="bufferSize" min="1" max="20" step="1" value="5">
  </div>

  <div class="controls">
    <h3>Axis Filters</h3>
    <button onclick="setAxisFilter('all')">All</button>
    <button onclick="setAxisFilter('x')">Ignore X</button>
    <button onclick="setAxisFilter('y')">Ignore Y</button>
    <button onclick="setAxisFilter('z')">Ignore Z</button>
    <button onclick="setAxisFilter('xy')">Ignore X+Y</button>
    <button onclick="setAxisFilter('yz')">Ignore Y+Z</button>
    <button onclick="setAxisFilter('zx')">Ignore Z+X</button>
  </div>

  <div id="sensorData">
    <h3>Sensor Readings</h3>
    <table>
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>X</th>
          <th>Y</th>
          <th>Z</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="dataTable"></tbody>
    </table>
    <button id="downloadBtn">Download Data</button>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const thresholdSlider = document.getElementById("threshold");
    const bufferSlider = document.getElementById("bufferSize");
    const thresholdValueEl = document.getElementById("thresholdValue");
    const bufferValueEl = document.getElementById("bufferValue");
    const dataTable = document.getElementById("dataTable");

    let threshold = parseFloat(thresholdSlider.value);
    let bufferSize = parseInt(bufferSlider.value);
    let motionData = [];
    let axisFilter = "all"; // default

    thresholdSlider.addEventListener("input", () => {
      threshold = parseFloat(thresholdSlider.value);
      thresholdValueEl.textContent = threshold.toFixed(1);
    });

    bufferSlider.addEventListener("input", () => {
      bufferSize = parseInt(bufferSlider.value);
      bufferValueEl.textContent = bufferSize;
    });

    function setAxisFilter(filter) {
      axisFilter = filter;
      alert("Axis filter set to: " + filter.toUpperCase());
    }

    function updateStatus(isMoving) {
      if (isMoving) {
        statusEl.textContent = "ðŸš¶ Phone is Moving";
        statusEl.className = "moving";
      } else {
        statusEl.textContent = "ðŸ›‘ Phone is Stopped";
        statusEl.className = "stopped";
      }
    }

    function startDetection() {
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(response => {
          if (response === 'granted') {
            window.addEventListener('devicemotion', motionHandler);
          } else {
            alert('Permission denied for motion sensors');
          }
        });
      } else {
        window.addEventListener('devicemotion', motionHandler);
      }
    }

    let lastAcceleration = { x: 0, y: 0, z: 0 };
    let deltas = [];
    let lastMoveTime = 0;
    let isMoving = false;

    function motionHandler(event) {
      if (!event.accelerationIncludingGravity) return;

      const acc = event.accelerationIncludingGravity;

      // Apply axis filter
      let dx = (axisFilter.includes('x')) ? 0 : acc.x - lastAcceleration.x;
      let dy = (axisFilter.includes('y')) ? 0 : acc.y - lastAcceleration.y;
      let dz = (axisFilter.includes('z')) ? 0 : acc.z - lastAcceleration.z;

      const delta = Math.sqrt(dx*dx + dy*dy + dz*dz);

      deltas.push(delta);
      if (deltas.length > bufferSize) deltas.shift();

      const avgDelta = deltas.reduce((a, b) => a + b, 0) / deltas.length;

      if (avgDelta > threshold) {
        lastMoveTime = Date.now();
        if (!isMoving) {
          isMoving = true;
          updateStatus(true);
        }
      } else {
        if (isMoving && Date.now() - lastMoveTime > 2000) {
          isMoving = false;
          updateStatus(false);
        }
      }

      lastAcceleration = { x: acc.x, y: acc.y, z: acc.z };

      const row = `<tr><td>${new Date().toLocaleTimeString()}</td><td>${acc.x.toFixed(2)}</td><td>${acc.y.toFixed(2)}</td><td>${acc.z.toFixed(2)}</td><td>${isMoving ? 'Moving' : 'Stopped'}</td></tr>`;
      dataTable.insertAdjacentHTML('afterbegin', row);

      motionData.push({
        timestamp: new Date().toISOString(),
        x: acc.x,
        y: acc.y,
        z: acc.z,
        status: isMoving ? 'Moving' : 'Stopped'
      });
    }

    document.getElementById("startBtn").addEventListener("click", startDetection);

    document.getElementById("downloadBtn").addEventListener("click", () => {
      let csvContent = "data:text/csv;charset=utf-8,Timestamp,X,Y,Z,Status\\n";
      motionData.forEach(row => {
        csvContent += `${row.timestamp},${row.x},${row.y},${row.z},${row.status}\\n`;
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "motion_data.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
